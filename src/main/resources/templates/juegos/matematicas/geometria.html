<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Adivina la Figura</title>
  <style>
    body { 
      text-align: center; 
      font-family: Arial, sans-serif; 
    }
    
    .game-container {
      position: relative;
      width: 460px;
      margin: 0 auto;
    }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 150px);
      grid-template-rows: repeat(3, 150px);
      gap: 5px;
      margin: 20px auto;
      width: 460px;
    }
    
    .casilla {
      width: 150px;
      height: 150px;
      background-color: #000;
      position: relative;
      overflow: hidden;
    }
    
    .imagen-completa {
      display: block;
      width: 460px;
      height: auto;
      margin: 0 auto 20px;
    }
    
    .imagen-fondo {
      position: absolute;
      width: 460px; /* Ancho de la imagen completa */
      height: 460px; /* Alto de la imagen completa */
      z-index: 1;
    }
    
    .cover {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      z-index: 2;
      transition: opacity 0.3s;
    }
    
	.casilla {
	  pointer-events: none; /* Desactiva todos los eventos del mouse */
	}
    
    .opciones {
      margin-top: 20px;
      
    }
    
    .opciones button {
      margin: 0 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    
    #mensaje {
      margin: 20px 0;
      font-weight: bold;
      min-height: 24px;
    }
  </style>
</head>
<body>
  <h1>Adivina la Figura</h1>

  <div class="game-container">
   
    <!-- Rompecabezas - 3x3 grid -->
    <div class="grid">
      <div th:each="i : ${#numbers.sequence(1, 9)}" 
           class="casilla"
           th:with="xPos=${(i-1)%3*150}, yPos=${T(java.lang.Math).floor((i-1)/3)*150}"
           onclick="desbloquearCasilla(this)">
        <img class="imagen-fondo" th:src="@{${figuraCompleta}}" 
             th:style="'left: -' + ${xPos} + 'px; top: -' + ${yPos} + 'px;'">
        <div class="cover"></div>
      </div>
    </div>
  </div>

  <!-- Opciones de respuesta -->
  <div class="opciones">
    <p>¿Qué figura es?</p>
    <button onclick="enviarRespuesta('Triángulo')">Triángulo</button>
    <button onclick="enviarRespuesta('Rectangulo')">Rectangulo</button>
    <button onclick="enviarRespuesta('Pentágono')">Pentágono</button>
    <button onclick="desbloquearCasillaAleatoria()">Desbloquear casilla aleatoria</button>
  </div>

  <!-- Mensaje de resultado -->
  <p id="mensaje"></p>

<script>
  console.log("Script de geometría cargado");
  
  // Inyecta el valor de la respuesta correcta desde el controlador
  // Asegúrate de que desde el controlador se esté enviando, por ejemplo, "Triángulo"
  var respuestaCorrecta = "[[${respuestaCorrecta}]]";
  
  // Variables para controlar el estado
  var casillasDesbloqueadas = 0;
  var totalCasillas = 9; // Ahora son 9 casillas (3x3)
  var respuestaSeleccionada = false;
  var tiempoInicio = Date.now();

  // Función para desbloquear una casilla
  function desbloquearCasilla(element) {
    if (respuestaSeleccionada) return;
    
    const cover = element.querySelector('.cover');
    if (!cover) return;
    
    cover.style.opacity = '0';
    setTimeout(() => element.removeChild(cover), 300);
    casillasDesbloqueadas++;
    
    if (casillasDesbloqueadas === totalCasillas) {
      document.getElementById('mensaje').innerText = "¡Imagen completa desbloqueada!";
    }
  }

  // Función para enviar la respuesta seleccionada
  function enviarRespuesta(opcion) {
    if (respuestaSeleccionada) return;
    respuestaSeleccionada = true;
    var tiempoRespuesta = Math.floor((Date.now() - tiempoInicio) / 1000);

    // Compara la respuesta seleccionada con la respuesta correcta (ignora mayúsculas y espacios)
    var esCorrecto = opcion.trim().toLowerCase() === respuestaCorrecta.trim().toLowerCase();
    var mensaje = "";
    if (esCorrecto) {
      if (casillasDesbloqueadas < totalCasillas) {
        mensaje = `¡Correcto! Ganaste con bonificación (${totalCasillas - casillasDesbloqueadas} casillas ocultas). Tiempo: ${tiempoRespuesta} segundos`;
      } else {
        mensaje = `¡Correcto! Pero revelaste toda la imagen. Tiempo: ${tiempoRespuesta} segundos`;
      }
    } else {
      mensaje = `¡Incorrecto! La respuesta correcta es: ${respuestaCorrecta}. Tiempo: ${tiempoRespuesta} segundos`;
    }
    document.getElementById('mensaje').innerText = mensaje;
    
    // Guarda la puntuación usando cierta lógica: por ejemplo, solo se otorga bonificación
    // si la respuesta es correcta y aún quedan casillas ocultas.
    guardarPuntuacionGeometria(tiempoRespuesta, esCorrecto && (casillasDesbloqueadas < totalCasillas));
  }

  // Función para guardar la puntuación
  function guardarPuntuacionGeometria(tiempo, victoria) {
    fetch('/juegos/matematicas/guardar-puntuacion-geometria', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tiempo: tiempo, victoria: victoria })
    })
    .then(response => {
      if (!response.ok) throw new Error('Error guardando la puntuación');
      console.log('Puntuación guardada exitosamente.');
    })
    .catch(error => console.error('Error:', error));
  }
  
  // Función para desbloquear una casilla aleatoria
  function desbloquearCasillaAleatoria() {
    const casillas = document.querySelectorAll('.casilla');
    const casillasBloqueadas = Array.from(casillas).filter(c => 
      c.querySelector('.cover') !== null
    );
    
    if (casillasBloqueadas.length > 0) {
      const randomIndex = Math.floor(Math.random() * casillasBloqueadas.length);
      desbloquearCasilla(casillasBloqueadas[randomIndex]);
    }
  }
</script>

  
  <br>
  <a href="/juegos/home-matematicas">Volver al inicio</a>
</body>
</html>